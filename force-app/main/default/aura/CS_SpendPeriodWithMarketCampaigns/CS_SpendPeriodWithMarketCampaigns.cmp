<aura:component implements="force:appHostable" controller="CS_CostSystem_Controller" access="global">
    <aura:attribute name="isEditing" type="Boolean" default="false" />
    <aura:attribute name="createCampaign" type="Boolean" default="false" />
    <aura:attribute name="isEditingSpendPeriod" type="Boolean" default="false" />
    <aura:attribute name="createSpendPeriod" type="Boolean" default="false" />
    <aura:attribute name="campaignInstance" type="Marketing_Campaign__c" access="global" default="{'sobjectType':'Marketing_Campaign__c'}" />
    <aura:attribute name="spendPeriodInstance" type="Marketing_Campaign__c" access="global" default="{'sobjectType':'Marketing_Spend_Period__c'}" />
    <aura:attribute name="spendPeriodList" type="List" default="[]" access="global" />
    <aura:attribute name="formatededSpendPeriodList" type="List" default="[]" access="global" />
    <aura:attribute name="picklistOptions" type="List" default="[]" access="global" />
    <aura:attribute name="spendPeriodToDelete" type="List" default="[]" access="global" />
    <aura:attribute name="spendPeriodToSave" type="List" default="[]" access="global" />
    <aura:attribute name="campaignList" type="List" default="[]" access="global" />
    <aura:attribute name="openModelToSaveSpendPeriod" type="Boolean" default="false" />
    <aura:attribute name="isOverlappingSpendPeriod" type="Boolean" default="false" />
    <aura:attribute name="openDeleteConfirmationModel" type="Boolean" default="false" />
    <aura:attribute name="selectedIndex" type="Integer" default="0" access="global" />
    <aura:attribute name="originalSpendPeriodList" type="List" default="[]" access="global" />
    <aura:attribute name="openScriptProcessModel" type="Boolean" default="false" />
    <aura:attribute name="runProcessscriptLable" type="String" default="Yes" />
    <aura:attribute name="disableButton" type="Boolean" default="false" />
    <aura:attribute name="startAndEndMatchNotFound" type="Boolean" default="false" />

    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
    <!-- pagination -->
    <aura:attribute name="pageSize" type="Integer" default="4" />
    <aura:attribute name="totalPage" type="Integer" default="0" />
    <aura:attribute name="pageNumber" type="Integer" default="1" />
    <aura:attribute name="totalRecountCount" type="Integer" default="0" />
    <aura:attribute name="startingRecord" type="Integer" default="1" />
    <aura:attribute name="endingRecord" type="Integer" default="1" />
    <aura:attribute name="data" type="List" default="[]" access="global" />
    <!-- pagination end -->

    <div class="slds-card slds-p-around_small">
        <lightning:layout multipleRows="true">
            <lightning:layoutItem size="12" smallDeviceSize="12" mediumDeviceSize="12" largeDeviceSize="12">
                <div class="slds-text-align_center" style="font-size: x-large;">
                    Edit {!v.campaignInstance.Name} Market Campaign
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="Name" value="{!v.campaignInstance.Name}" required="true" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="UTM Source" value="{!v.campaignInstance.UTM_Source__c}" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="UTM Campaign" value="{!v.campaignInstance.UTM_Campaign__c}" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="UTM Medium" value="{!v.campaignInstance.UTM_Medium__c}" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="UTM Term" value="{!v.campaignInstance.UTM_Term__c}" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_small" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <div class="slds-p-around_xx-small">
                    <lightning:input name="input1" label="UTM Content" value="{!v.campaignInstance.UTM_Content__c}" />
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem class="slds-p-around_medium slds-m-bottom_large" size="3" largeDeviceSize="3" mediumDeviceSize="3" smallDeviceSize="3">
                <lightning:select name="outcomeProfiles" label="Cost Category" value="{!v.campaignInstance.Cost_Category__c}" required="true">
                    <option value="">Choose one...</option>
                    <aura:iteration items="{!v.picklistOptions}" var="op">
                        <option value="{!op.value}">{!op.label}</option>
                    </aura:iteration>
                </lightning:select>
            </lightning:layoutItem>
            <lightning:layoutItem size="12" smallDeviceSize="12" mediumDeviceSize="12" largeDeviceSize="12">
                <div class="slds-text-align_center" style="font-size: x-large;">
                    Spend Periods
                </div>
            </lightning:layoutItem>
            <lightning:layoutItem size="12" largeDeviceSize="12" mediumDeviceSize="12" smallDeviceSize="12" class="">
                <table class="slds-table slds-table_bordered slds-table_striped slds-scrollable_x anotherhover" style="table-layout: fixed;">
                    <thead>
                        <tr class="slds-line-height_reset">
                            <th class="slds-text-title_caps slds-cell-wrap" scope="col" title="Start interval">
                                <div class="slds-truncate slds-text-align_center">Start interval</div>
                            </th>
                            <th class="slds-text-title_caps slds-cell-wrap" scope="col" title="End interval">
                                <div class="slds-truncate slds-text-align_center slds-p-around_x-small"> End interval
                                </div>
                            </th>
                            <th class="slds-text-title_caps slds-cell-wrap" scope="col" title="Spend amount">
                                <div class="slds-truncate slds-text-align_center slds-p-around_x-small">Spend amount
                                </div>
                            </th>
                            <th class="slds-text-title_caps slds-cell-wrap" scope="col" title="Lead processed">
                                <div class="slds-truncate slds-text-align_center slds-p-around_x-small">Lead processed
                                </div>
                            </th>
                            <th class="slds-text-title_caps slds-cell-wrap" scope="col" title="Action">
                                <div class="slds-truncate slds-text-align_center slds-p-around_x-small">Action
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>

                        <aura:if isTrue="{!v.spendPeriodList.length == 0}">
                            <tr class="slds-hint-parent">
                                <th scope="row" colspan="4" class="slds-cell-wrap">
                                    <div class="slds-truncate slds-text-align_center slds-text-heading_small">
                                        There are no spend periods available.</div>
                                </th>
                            </tr>
                            <aura:set attribute="else">
                                <aura:iteration var="sp" items="{!v.data}" indexVar="tabIndex">
                                    <tr class="slds-hint-parent">
                                        <td scope="row" class="slds-cell-wrap wrapWord" align="left">
                                            <div class="slds-truncate slds-text-align_left slds-p-around_x-small">
                                                <p class="slds-truncate slds-text-align_center">
                                                    <b>
                                                    <lightning:formattedDateTime value="{!sp.Period_start_time__c}" year="numeric" month="numeric" day="numeric" hour="2-digit" minute="2-digit"   hour12="false" /></b>
                                                </p>
                                            </div>
                                        </td>
                                        <td scope="row" class="slds-cell-wrap wrapWord" align="left">
                                            <div class="slds-truncate slds-text-align_left slds-p-around_x-small">
                                                <p class="slds-truncate slds-text-align_center">
                                                    <b>
                                                    <lightning:formattedDateTime value="{!sp.Period_end_time__c}" year="numeric" month="numeric" day="numeric" hour="2-digit" minute="2-digit"   hour12="false" /></b>
                                                </p>
                                            </div>
                                        </td>
                                        <td scope="row" class="slds-cell-wrap wrapWord" align="left">
                                            <div class="slds-truncate slds-text-align_left slds-p-around_x-small">
                                                <p class="slds-truncate slds-text-align_center">
                                                    <b>{!sp.Total_spend__c}</b>
                                                </p>
                                            </div>
                                        </td>
                                        <td scope="row" class="slds-cell-wrap wrapWord" align="left">
                                            <div class="slds-truncate slds-text-align_left slds-p-around_x-small">
                                                <p class="slds-truncate slds-text-align_center">
                                                    <b>{!sp.Lead_Processed__c}</b>
                                                </p>
                                            </div>
                                        </td>
                                        <td class="slds-truncate slds-text-align_center">
                                            <lightning:buttonIcon alternativeText="Edit" iconName="utility:edit" variant="border" onclick="{!c.editMarketingSpendPeriod}" title="Edit" tabindex="{!tabIndex}" name="EditMarketingCampaign" />
                                            <lightning:buttonIcon iconName="utility:delete" variant="border" onclick="{! c.openDeleteSpendPeriodModel }" alternativeText="Delete" tabindex="{!tabIndex}" title="Delete" />
                                            <lightning:buttonIcon iconName="utility:redo" variant="border" onclick="{! c.openProcessScriptModel }" alternativeText="Process" tabindex="{!tabIndex}" title="Process" disabled="{!sp.Id == null}" />

                                        </td>
                                    </tr>
                                </aura:iteration>
                            </aura:set>
                        </aura:if>
                    </tbody>
                </table>
            </lightning:layoutItem>
        </lightning:layout>


        <!-- Pagination -->
        <aura:if isTrue="{!v.spendPeriodList.length > 0}">
            <div class="slds-align_absolute-center slds-m-top_small">
                <div class="slds-p-right_xx-small">
                    <lightning:button label="Prev" onclick="{!c.handlePrev}" disabled="{!v.pageNumber == 1}" iconName="utility:back" name="prev"></lightning:button>
                </div>
                <span class="slds-badge slds-badge_lightest">
                Page {!v.pageNumber} of {!v.totalPage}
              </span>
                <div class="slds-p-left_xx-small">
                    <lightning:button label="Next" onclick="{!c.handleNext}" disabled="{!v.pageNumber >= v.totalPage}" iconName="utility:forward" iconPosition="right" name="next">
                    </lightning:button>
                </div>
            </div>
        </aura:if>
        <!-- Pagination -->


        <div class="slds-text-align_right button-padding slds-p-top_small">
            <lightning:button class="slds-m-bottom_large" type="button" variant="brand" label="Create new spend period" iconName="utility:add" iconPosition="left" onclick="{!c.openNewSpendPeriodModel}" />
        </div>
        <div class="slds-text-align_right button-padding slds-p-top_small">
            <lightning:button class="slds-m-bottom_large" type="button" variant="brand" label="Save" iconName="utility:check" iconPosition="left" onclick="{!c.saveCampaignsAndSpendPeriods}" />
            <lightning:button class="slds-m-bottom_large" type="button" label="Cancel" iconName="utility:close" iconPosition="left" onclick="{!c.hideEditCampaignPage}" />
        </div>

        <!-- Create / Edit spend period model -->
        <aura:if isTrue="{!v.createSpendPeriod}">
            <div>

                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container" style="width:95%">
                        <header class="slds-modal__header">
                            <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">
                                <aura:if isTrue="{!v.isEditingSpendPeriod}">
                                    Edit Spend Period
                                    <aura:set attribute="else">
                                        Create Spend Period
                                    </aura:set>
                                </aura:if>
                            </h2>
                        </header>
                        <div class="slds-modal__content slds-p-around_small" id="modal-content-id-1">
                            <lightning:layout multipleRows="true">
                                <lightning:layoutItem size="12" largeDeviceSize="12" mediumDeviceSize="12" smallDeviceSize="12">
                                    <div class="slds-p-around_xx-small">
                                        <lightning:layout multipleRows="true">
                                            <lightning:layoutItem class="slds-p-around_small" size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                                <lightning:input type="number" name="Total Spend" label="Total Spend" value="{!v.spendPeriodInstance.Total_spend__c}" required="true" />
                                            </lightning:layoutItem>
                                        </lightning:layout>

                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem class="slds-p-around_small" size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div class="slds-p-around_xx-small">
                                        <lightning:input type="datetime" name="Start Period" label="Start period" value="{!v.spendPeriodInstance.Period_start_time__c}"  required="true" />
                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem class="slds-p-around_small" size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div class="slds-p-around_xx-small">
                                        <lightning:input type="datetime" name="End Period" label="End period" value="{!v.spendPeriodInstance.Period_end_time__c}" required="true" />

                                    </div>
                                </lightning:layoutItem>
                            </lightning:layout>
                        </div>
                        <footer class="slds-modal__footer">
                            <aura:if isTrue="{!v.isEditingSpendPeriod}">
                                <lightning:button type="button" title="Update spend period" label="Update spend period" iconName="utility:save" iconPosition="left" onclick="{!c.saveSpendPeriod}" variant="brand" />
                                <aura:set attribute="else">
                                    <lightning:button type="button" title="Create spend period" label="Create spend period" iconName="utility:save" iconPosition="left" onclick="{!c.saveSpendPeriod}" variant="brand" />
                                </aura:set>
                            </aura:if>

                            <lightning:button type="button" label="Cancel" iconName="utility:close" iconPosition="left" onclick="{!c.closeSpendPeriodCreateModal}" />
                        </footer>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>

            </div>
        </aura:if>
        <!-- Model for confirmation to create/edit spend period record -->
        <aura:if isTrue="{!v.openModelToSaveSpendPeriod}">
            <div class="slds-p-around_medium">

                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container" style="width:34%">
                        <div class="slds-modal__content slds-p-around_small" id="modal-content-id-1">
                            <lightning:layout multipleRows="true">
                                <lightning:layoutItem size="12" largeDeviceSize="12" mediumDeviceSize="12" smallDeviceSize="12">
                                    <div class="slds-align_absolute-center slds-text-heading_medium slds-p-around_medium">
                                        <aura:if isTrue="{!v.isOverlappingSpendPeriod}">
                                            <p>Spend period overlapping with existing spend period, Do you want to continue?</p>
                                            <aura:set attribute="else">
                                                <aura:if isTrue="{!v.startAndEndMatchNotFound}">
                                                    <p>Do you want to continue?</p>
                                                </aura:if>
                                            </aura:set>
                                        </aura:if>

                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="right" class="slds-p-around_medium">
                                        <lightning:button variant="brand" label="Yes" title="Yes" onclick="{! c.saveSpendPeriodToList }" iconName="utility:check" iconPosition="left" />
                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="left" class="slds-p-around_medium">
                                        <lightning:button variant="brand" label="No" title="No" onclick="{! c.closeSpendPeriodConfirmationModel }" iconName="utility:close" iconPosition="left" />
                                    </div>
                                </lightning:layoutItem>
                            </lightning:layout>
                        </div>

                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>

            </div>
        </aura:if>

        <!-- Model for confirmation to delete spend period record -->
        <aura:if isTrue="{!v.openDeleteConfirmationModel}">
            <div class="slds-p-around_medium">

                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container" style="width:34%">
                        <div class="slds-modal__content slds-p-around_small" id="modal-content-id-1">
                            <lightning:layout multipleRows="true">
                                <lightning:layoutItem size="12" largeDeviceSize="12" mediumDeviceSize="12" smallDeviceSize="12">
                                    <div class="slds-align_absolute-center slds-text-heading_medium slds-p-around_medium">

                                        <p> Do you want to continue?</p>


                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="right" class="slds-p-around_medium">
                                        <lightning:button variant="brand" label="Yes" title="Yes" onclick="{! c.deleteSpendPeriodFromUI }" iconName="utility:check" iconPosition="left" />
                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="left" class="slds-p-around_medium">
                                        <lightning:button variant="brand" label="No" title="No" onclick="{! c.openDeleteSpendPeriodModel }" iconName="utility:close" iconPosition="left" />
                                    </div>
                                </lightning:layoutItem>
                            </lightning:layout>
                        </div>

                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>

            </div>
        </aura:if>
        <!-- Open process script model -->
        <aura:if isTrue="{!v.openScriptProcessModel}">
            <div class="slds-p-around_medium">

                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container" style="width:34%">
                        <div class="slds-modal__content slds-p-around_small" id="modal-content-id-1">
                            <lightning:layout multipleRows="true">
                                <lightning:layoutItem size="12" largeDeviceSize="12" mediumDeviceSize="12" smallDeviceSize="12">
                                    <div class="slds-align_absolute-center slds-text-heading_medium slds-p-around_medium">

                                        <p>Do you want to run the cost process script?</p>


                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="right" class="slds-p-around_medium">
                                        <lightning:button variant="brand" label="{!v.runProcessscriptLable}" title="{!v.runProcessscriptLable}" onclick="{! c.runProcessScript }" iconName="utility:check" iconPosition="left" disabled="{!v.disableButton}" />
                                    </div>
                                </lightning:layoutItem>
                                <lightning:layoutItem size="6" largeDeviceSize="6" mediumDeviceSize="6" smallDeviceSize="6">
                                    <div align="left" class="slds-p-around_medium">
                                        <lightning:button label="Cancel" title="Cancel" onclick="{! c.openProcessScriptModel }" iconName="utility:close" iconPosition="left" disabled="{!v.disableButton}" />
                                    </div>
                                </lightning:layoutItem>
                            </lightning:layout>
                        </div>

                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>

            </div>
        </aura:if>
    </div>
</aura:component>